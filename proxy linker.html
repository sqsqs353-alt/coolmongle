<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fullscreen iframe Embed</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }

    /* Fullscreen iframe */
    #player {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    /* Overlay that asks for the link */
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
    }

    .card {
      width: 100%;
      max-width: 760px;
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card h1 { font-size: 18px; margin-bottom: 4px; }
    .card p { font-size: 13px; color: #444; margin-bottom: 8px; }

    form { display: flex; gap: 8px; }
    input[type="url"] {
      flex: 1;
      padding: 10px 12px;
      font-size: 15px;
      border: 1px solid #d0d4d9;
      border-radius: 8px;
      outline: none;
    }
    input[type="url"]:focus { box-shadow: 0 0 0 3px rgba(0,120,212,0.12); border-color: #0078d4; }

    button {
      padding: 10px 14px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    button.primary { background: #0078d4; color: #fff; }
    button.ghost { background: transparent; color: #0078d4; border: 1px solid #cfe6ff; }

    /* Small change button so user can reopen the overlay */
    #changeBtn {
      position: fixed;
      left: 12px;
      top: 12px;
      z-index: 10000;
      background: rgba(255,255,255,0.9);
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      cursor: pointer;
      font-size: 14px;
    }

    @media (max-width: 420px) {
      .card { padding: 12px; border-radius: 8px; }
      h1 { font-size: 16px; }
    }
  </style>
</head>
<body>
  <button id="changeBtn" title="Change embed URL">Change URL</button>

  <iframe
    id="player"
    src=""
    allowfullscreen
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
  ></iframe>

  <div id="overlay" role="dialog" aria-modal="true" aria-label="Enter a URL to embed">
    <div class="card">
      <h1>Open a link in the fullscreen iframe</h1>
      <p>Enter the URL you want to load. You can omit the protocol (http/https) â€” it will default to https://.</p>

      <form id="urlForm">
        <input id="urlInput" type="url" inputmode="url" placeholder="https://example.com or web.cloudmoonapp.com/..." aria-label="URL to load" />
        <button class="primary" type="submit">Load</button>
        <button class="ghost" id="cancelBtn" type="button">Cancel</button>
      </form>

      <p style="font-size:12px;color:#666;margin-top:6px;">Tip: Use "Change URL" (top-left) later to load a different link.</p>
    </div>
  </div>

  <script>
    (function () {
      const overlay = document.getElementById('overlay');
      const form = document.getElementById('urlForm');
      const input = document.getElementById('urlInput');
      const iframe = document.getElementById('player');
      const changeBtn = document.getElementById('changeBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const STORAGE_KEY = 'cloudmoon_last_url';

      // Prefill the input with previously used URL but still ask for confirmation
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) input.value = saved;

      // Helper: sanitize/normalize the URL
      function normalizeUrl(raw) {
        if (!raw) return null;
        raw = raw.trim();
        // If user only pasted something like "example.com/path", add https://
        if (!/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(raw)) {
          raw = 'https://' + raw;
        }
        try {
          // This will throw on invalid urls
          const u = new URL(raw);
          return u.toString();
        } catch (e) {
          return null;
        }
      }

      form.addEventListener('submit', function (ev) {
        ev.preventDefault();
        let raw = input.value || '';
        const normalized = normalizeUrl(raw);
        if (!normalized) {
          alert('Please enter a valid URL (for example: https://example.com).');
          input.focus();
          return;
        }

        // Set iframe src and hide overlay
        iframe.src = normalized;
        localStorage.setItem(STORAGE_KEY, normalized);
        overlay.style.display = 'none';
      });

      // Cancel: just hide overlay but don't set iframe.src (if none set, iframe stays blank)
      cancelBtn.addEventListener('click', function () {
        overlay.style.display = 'none';
      });

      // Change button re-opens the overlay
      changeBtn.addEventListener('click', function () {
        overlay.style.display = 'flex';
        // focus at end of value
        input.focus();
        input.setSelectionRange(input.value.length, input.value.length);
      });

      // If the user presses Escape, close the overlay
      document.addEventListener('keydown', function (ev) {
        if (ev.key === 'Escape' && overlay.style.display !== 'none') {
          overlay.style.display = 'none';
        }
      });

      // Optionally, if there's no saved url and the overlay is shown, focus input
      window.addEventListener('load', function () {
        setTimeout(() => {
          if (overlay.style.display !== 'none') input.focus();
        }, 50);
      });
    })();
  </script>
</body>
</html>
